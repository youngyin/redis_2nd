## 프로젝트 목표
2주차는 **조회 페이지의 성능 개선**에 초점을 맞췄습니다. Indexing, Caching 을 적용하면서 단계별로 성능 측정 및 성능 최적화 하는 것을 경험합니다.

너무 구현에만 몰두 하다보면, 리뷰 과정에서 내가 왜 이렇게 설계 했는지에 대해서 충분히 설명하기 힘들 수 있습니다. **이론 공부에도 충분한 시간을 쏟으며 구현과 같이 병행**해주시면 좋을 것 같습니다.


## 과제 목표

---

- **API Refactoring**
    - 1주차에 구현한 조회 API 에 검색 기능 추가
    - 검색 기능 추가 이후 부하 테스트를 진행 합니다.
- **Indexing**
    - 1주차와 2주차의 비지니스 요구사항을 참고하여, 적절한 Index 를 생성하고, 부하 테스트를 진행합니다.
- **Caching**
    - 메인 페이지 성능을 위해 Redis 캐싱을 활용하고 부하 테스트를 진행합니다.

## **비즈니스 요구 사항**

---

![상영 중인 영화 조회 API](https://prod-files-secure.s3.us-west-2.amazonaws.com/83c75a39-3aba-4ba4-a792-7aefe4b07895/556346e8-b015-4a77-a5c1-46266a2c8482/Screenshot_2024-12-18_at_23.09.30.png)

상영 중인 영화 조회 API

- 검색 요구 사항이 추가되었습니다. 영화 제목으로 검색할 수 있으며, 영화 장르로 필터링 또한 가능합니다.
    - 제목, 장르 외의 항목을 통한 검색 및 필터링은 불가능합니다.
    - 기존 1주차에서 구현한 API 에 영화 제목과 장르로 필터링 가능하도록 기능을 추가해야 합니다. (별도 API 로 구성하지 말아주세요)
    - 참고 (1주차 요구 사항)
        - 메인 페이지는 ‘개봉일’ 순서로 정렬되어야 합니다. 또한 시간표는 그림과 같이 시작시간이 빠른 것부터 정렬되어야 합니다.
- 우리 서비스는 niche market 특징을 가지고 있습니다. 다른 영화관과 달리 아주 오래된 영화, 비 인기 영화 등도 상영하기 때문에, 메인 페이지에 노출되는 영화 항목이 많게는 500개 이상 됩니다. 따라서 메인 페이지에 대한 성능을 올려야 합니다.

## 기술 스택

---

- **Caffeine**
    - 로컬 캐싱을 위해 Caffeine 를 활용합니다.
    - https://hogwart-scholars.tistory.com/entry/CacheSpring-EhCache-vs-Cache2k-vs-Caffeine-%EC%BA%90%EC%8B%9C-%EB%B9%84%EA%B5%90%ED%95%98%EA%B8%B0
    - https://www.baeldung.com/spring-boot-caffeine-cache
    - https://medium.com/naverfinancial/%EB%8B%88%EB%93%A4%EC%9D%B4-caffeine-%EB%A7%9B%EC%9D%84-%EC%95%8C%EC%95%84-f02f868a6192
- **Redisson Library**
    - 분산 캐싱을 위해 Redis 를 활용합니다.
- **K6**
    - https://grafana.com/blog/2021/01/27/k6-vs-jmeter-comparison/
    - 성능 측정을 위한 도구로 JMeter, Locust 등 다양한 툴들이 많습니다.
    - 이번 주차의 본질은 성능 측정 결과 항목들을 분석하고, 개선하는 것입니다. GUI 는 중요하지 않다고 판단하여 가볍고 스크립트 작성이 편리한 K6 를 부하 테스트 도구로 선택하였습니다.

## **기술 요구 사항**

---

<aside>
⚡

성능을 최적화 하기 위한 여러 기술들을 단계적으로 구현하며 관련 기반 지식들을 충분히 학습하는 것을 추천합니다.

추천하는 흐름은 다음과 같습니다.

1. 1주차에서 구현한 API 에 대해서 성능 테스트를 진행
2. 2주차 요구 사항인 검색 기능을 추가하여 성능 테스트를 진행
3. 인덱스를 추가하고, 실행 계획을 확인하며 성능 테스트를 진행
4. 단일 인스턴스 환경에서는 분산 캐시가 필요 없습니다. 로컬 캐시를 적용하고 성능 테스트를 진행
5. 분산 애플리케이션을 위한 캐시를 적용하고 성능 테스트를 진행
</aside>

### 필수 사항

- Redis 도 Docker 로 띄웁니다.
- API
    - 검색 기능 추가 시, 조회 결과는 꼭 필요한 데이터만 포함되어있어야 합니다. Projection 을 사용하는 방식으로 쿼리를 수정해야 합니다. (동적 쿼리가 필요하다면 QueryDsl 을 사용해주세요. 타입 안전성, 동적 쿼리 작성, 재사용성 측면에서 이점이 있습니다.)
    - 1주차 비지니스 요구사항에 명시 되어있던 꼭 필요한 데이터는 다음과 같습니다.
        - 영화 제목, [영상물 등급](https://namu.wiki/w/%EC%98%81%EC%83%81%EB%AC%BC%20%EB%93%B1%EA%B8%89%20%EC%A0%9C%EB%8F%84/%EB%8C%80%ED%95%9C%EB%AF%BC%EA%B5%AD), 개봉일, 썸네일 이미지, 러닝 타임(분), 영화 장르, 상영관 이름, 상영 시간표
    - 클라이언트로 부터 전달 받은 요청 값은 신뢰할 수 없습니다. **요청 값에 대한 validation** 도 진행해야 합니다.
        - 예를 들어, 영화 제목 컬럼의 사이즈가 varchar(255) 인 경우, 이 것보다 큰 제목이 들어오면 검증 예외를 던져줘야 합니다.
    - 캐시를 적용할 때 Cache Miss 시 DB 조회 결과를 응답으로 내주도록 로직을 작성해야 합니다.
- 인덱스
    - 인덱스를 추가하고 나서, 제목 검색 시 **like** 와 **동등연산자(=)** 를 각각 활용해보며, 어떤 차이가 있는지 실행 계획으로 확인하시면 좋습니다. 최종 쿼리 형태는 where 조건에 title 에 대해서 동등 연산자를 활용합니다. 단, **인덱스는 Like 연산자를 고려하여 설계** 해주세요.
- 성능 테스트
    - 본래 **실제 사용자가 접속하는 환경**에서 진행되어야 합니다. 내부 네트워크에서 부하 테스트 진행 시 응답시간에 차이가 발생할 수 있습니다. 편의상 **로컬 환경에서 진행**합니다.
        - (참고) Spring Boot Application 은 Local 로 실행하며, MySQL, Redis 는 Docker 를 통해 연결되어야 합니다.
    - 성능에 가장 큰 영향을 주는 것은 DB 입니다.
    - 실무에서는 테스트 대상의 데이터가 실제 운영 환경과 동일하다고 가정해야 합니다.
    - 500개 이상의 충분한 데이터를 넣고 테스트 해주세요.
    - (참고) 성능 테스트를 수행하는 환경이 제한적이다 보니, 캐싱 결과가 인덱싱 결과랑 큰 차이가 없을 수도 있습니다. 단, 인덱스를 걸기 전과는 확연히 차이가 나야 합니다.
    - (참고) 본래 부하 테스트는 50분 이상 정도의 충분한 시간을 줘서 테스트하는게 맞지만, 현재는 인덱싱과 캐싱이 실제로 성능에 영향을 주는지를 가시적으로 확인하는 것이 주 목적(+ k6 부하 테스트 도구 사용 경험)입니다. 따라서 5~10분정도의 시간을 주고 테스트 하셔도 무방 합니다.
- 모듈이 추가로 필요하다고 판단되면, 자유롭게 생성 하면 됩니다.
- 아래 문서를 참고하여 성능 테스트 보고서를 작성해 주세요.

  [성능 테스트란 ?](https://www.notion.so/1bb2dc3ef514815a9c31f6c7b47be1bc?pvs=21)

  [성능 테스트 보고서](https://www.notion.so/1bb2dc3ef5148181bb7de91808ab12bd?pvs=21)


## README 에 반영되어야 하는 내용

---

- 어떤 데이터를 캐시할 것인지
- 성능 테스트 보고서

## 고려하지 않아도 되는 사항

---

- 다른 시스템과의 연동은 고려하지 않습니다.

## References

---

- https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC
- https://toss.tech/article/25301
- https://soobing.github.io/cs/6-caching-strategies/
- https://grafana.com/docs/k6/latest/testing-guides/test-types/
- https://blog.imqa.io/load_test1/
- https://blog.imqa.io/loadtesting2/
- https://www.linkedin.com/pulse/understanding-single-composite-indexes-sql-dat-nguyen-o2mac/
- https://dev.mysql.com/doc/refman/8.4/en/multiple-column-indexes.html